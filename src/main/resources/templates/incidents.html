<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Инциденты ИБ</title>

    <link rel="stylesheet" th:href="@{/css_styles/base.css}">
    <link rel="stylesheet" th:href="@{/css_styles/incidents.css}">
    <script defer th:src="@{/js_scrypts/incidents.js}"></script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body th:attr="data-role=${role}">
<input type="hidden" id="currentUserLogin" th:value="${currentUser}">
<div class="container">
    <!-- Заголовок -->
    <header>
        <h1>Инциденты ИБ</h1>
        <div class="header-buttons">
            <button class="icon-button" id="backButton">
                <img src="/web/static/icons/back.png" alt="Назад">
            </button>
            <button class="icon-button" id="logoutButton">
                <img src="/web/static/icons/logout.png" alt="Выход">
            </button>
        </div>
    </header>

    <!-- Основная карточка -->
    <div class="incident-card">
        <h3>Заведенные в системе инциденты информационной безопасности</h3>

        <!-- ШАПКА ТАБЛИЦЫ -->
        <div class="incident-header">
            <div class="incident-info">
                <strong>Инцидент</strong>
                <span>Описание</span>
            </div>

            <div class="incident-meta1">
                <span>Дата создания</span>
                <div class="level-header">
                    <span>Уровень</span>
                    <button class="filter-btn" id="levelFilterBtn" title="Фильтр">
                        <img src="/web/static/icons/filter.png" alt="Фильтр">
                    </button>
                    <img id="levelFilterActiveIcon" src="/web/static/icons/active-filter.png"
                         alt="Фильтр активирован"
                         title="Фильтр активирован"
                         class="filter-active-icon" style="display:none; cursor:pointer;">
                </div>

                <!-- Выпадающее окно фильтра -->
                <div class="filter-popup" id="levelFilterPopup">
                    <div class="filter-options" id="levelFilterOptions">
                        <!-- чекбоксы подгрузятся из /incidents/levels -->
                    </div>

                    <div class="filter-actions">
                        <button id="applyLevelFilter" class="danger">Применить</button>
                        <button id="cancelLevelFilter">Отмена</button>
                    </div>
                </div>
            </div>

            <div class="incident-meta2">
                <div class="level-header">
                    <span>Категория</span>
                    <button class="filter-btn" id="categoryFilterBtn" title="Фильтр">
                        <img src="/web/static/icons/filter.png" alt="Фильтр">
                    </button>
                    <img id="categoryFilterActiveIcon"
                         src="/web/static/icons/active-filter.png"
                         alt="Фильтр активирован"
                         title="Фильтр активирован"
                         class="filter-active-icon"
                         style="display:none; cursor:pointer;">
                </div>

                <!-- popup фильтра категории -->
                <div class="filter-popup" id="categoryFilterPopup">
                    <div class="filter-options" id="categoryFilterOptions">
                        <!-- чекбоксы подгрузятся из /incidents/categories -->
                    </div>

                    <div class="filter-actions">
                        <button id="applyCategoryFilter" class="danger">Применить</button>
                        <button id="cancelCategoryFilter">Отмена</button>
                    </div>
                </div>
            </div>


            <div class="incident-actions">
                <span>Действия</span>
            </div>
        </div>


        <!-- Список инцидентов -->
        <div class="incident-list" id="incidentList" th:if="${!#lists.isEmpty(incidents)}">
            <div class="incident-item"
                 th:each="incident : ${incidents}"
                 th:attr="data-id=${incident.id}">
                <div class="incident-info">
                    <strong th:text="${incident.title}">Название инцидента</strong>
                    <span th:text="${incident.description}">Описание инцидента</span>
                </div>

                <div class="incident-meta1">
                    <span th:text="${#temporals.format(incident.creationDate, 'HH:mm:ss dd.MM.yyyy')}">
                        00:00:00 01.01.2025
                    </span>
                    <span class="incident-level"
                          th:classappend="${incident.incidentLevel.name().toLowerCase()}"
                          th:text="${incident.incidentLevel.getLabel()}">
                        LOW
                    </span>
                </div>

                <div class="incident-meta2">
                    <div class="incident-cat"
                         th:attr="data-full-text=${incident.incidentCategory.getLabel()}">
                        <span class="cat-text"
                            th:text="${incident.incidentCategory.getLabel()}">
                        </span>
                    </div>
                </div>

                <div class="incident-actions">
                    <button class="edit-btn" title="Редактировать"
                            th:attr="data-id=${incident.id}">
                        <img src="/web/static/icons/edit.png" alt="Редактировать инцидент">
                    </button>
                    <button class="delete-btn" title="Удалить"
                            th:attr="data-id=${incident.id}">
                        <img src="/web/static/icons/delete.png" alt="Удалить инцидент">
                    </button>
                </div>
            </div>
        </div>

        <!-- Если нет инцидентов -->
        <div class="no-incidents" id="noIncidents" style="display:none;">
            Инциденты отсутствуют
        </div>

        <!-- Пагинация -->
        <div class="pagination" id="pagination"></div>

    </div>

    <!-- Кнопка добавления -->
    <button class="icon-add-button" id="addIncidentBtn">
        <img src="/web/static/icons/addInc.png" alt="Добавить инцидент">
    </button>
</div>

<!-- МОДАЛКА: ДОБАВЛЕНИЕ ИНЦИДЕНТА -->
<div id="incidentModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-frame">       <!-- тёмная рамка -->
        <div class="modal-content">   <!-- белое содержимое -->
            <button class="modal-close" id="incidentCloseBtn" aria-label="Закрыть">✖</button>
            <h2 class="modal-title">Добавление инцидента</h2>

            <label>Название</label>
            <input id="incidentTitle" type="text" placeholder="Введите название инцидента">

            <label>Описание</label>
            <textarea id="incidentDescription" placeholder="Введите описание"></textarea>

            <label>Категория</label>
            <select id="incidentCategory">
                <option value="">Выберите категорию</option>
            </select>

            <label>Уровень важности</label>
            <select id="incidentLevel">
                <option value="">Выберите уровень важности</option>
            </select>

            <div class="modal-actions">
                <button id="cancelIncidentBtn">Отмена</button>
                <button id="chooseRecsBtn" class="danger">Выбрать рекомендации</button>
                <button id="createIncidentBtn" class="danger" disabled>Создать</button>
            </div>
        </div>
    </div>
</div>

<!-- МОДАЛКА: ВЫБОР РЕКОМЕНДАЦИЙ -->
<div id="recsModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-frame">
        <div class="modal-content recs-content">
            <button class="modal-close" id="recsCloseBtn" aria-label="Закрыть">✖</button>
            <h2 class="modal-title">Рекомендации при обнаружении инцидента</h2>
            <div id="recsList" style="max-height:350px; overflow-y:auto; padding-right:6px;"></div>
            <div class="modal-actions" style="justify-content: center;">
                <button id="recsDoneBtn">Готово</button>
            </div>
        </div>
    </div>
</div>

<!-- МОДАЛКА: РЕДАКТИРОВАНИЕ ИНЦИДЕНТА -->
<div id="editIncidentModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-frame">
        <div class="modal-content">
            <button class="modal-close" id="editIncidentCloseBtn" aria-label="Закрыть">✖</button>
            <h2 class="modal-title">Редактирование инцидента</h2>

            <!-- НАЗВАНИЕ (нельзя менять) -->
            <label>Название</label>
            <input id="editIncidentTitle" type="text" disabled>

            <!-- ОПИСАНИЕ -->
            <label>Описание</label>
            <textarea id="editIncidentDescription" placeholder="Введите описание"></textarea>

            <!-- КАТЕГОРИЯ -->
            <label>Категория</label>
            <select id="editIncidentCategory">
                <option value="">Выберите категорию</option>
            </select>

            <!-- УРОВЕНЬ -->
            <label>Уровень важности</label>
            <select id="editIncidentLevel">
                <option value="">Выберите уровень важности</option>
            </select>

            <div class="modal-actions">
                <button id="cancelIncidentEditBtn">Отмена</button>
                <button id="editChooseRecsBtn" class="danger">Выбрать рекомендации</button>
                <button id="saveIncidentEditBtn" class="danger">Сохранить</button>
            </div>
        </div>
    </div>
</div>


<!-- МОДАЛКА: ПРОСМОТР ИНЦИДЕНТА -->
<div id="viewIncidentModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-frame-incident-data" style="max-width: 850px; width: 90%;">
        <div class="modal-scroll-area">
        <div class="modal-content-inc-data">
            <button class="modal-close" id="viewIncidentCloseBtn">✖</button>

            <div class="view-header">
                <img id="incidentShieldIcon" src="" alt="shield" class="shield-icon">
                <h2 id="incidentViewTitle">Название инцидента</h2>
            </div>

            <div class="view-block">
                <label>Дата и время заведения</label>
                <div id="incidentCreated"></div>
            </div>

            <div class="view-block">
                <label>Дата и время обновления</label>
                <div id="incidentUpdated"></div>
            </div>

            <div class="view-block">
                <label>Автор</label>
                <div id="incidentAuthor"></div>
            </div>

            <div class="view-block">
                <label>Описание инцидента</label>
                <div id="incidentDesc"></div>
            </div>

            <div class="view-block">
                <label>Категория</label>
                <div id="incidentCategoryView"></div>
            </div>

            <div class="view-block">
                <label>Рекомендации</label>
                <ul id="incidentRecsShort"></ul>
                <button id="showAllRecsBtn" class="link-btn" style="display:none;">Посмотреть все рекомендации</button>

                <ul id="incidentRecsFull" style="display:none; margin-top:10px;"></ul>
            </div>

        </div>
        </div>
    </div>
</div>

<!-- МОДАЛКА УДАЛЕНИЯ ИНЦИДЕНТА -->
<div id="deleteIncidentModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-frame">
        <div class="modal-content">
            <h2 id="deleteIncidentTitle">Удалить инцидент?</h2>
            <p>Подтвердите удаление</p>
            <div class="modal-actions">
                <button id="cancelDeleteBtn">Отмена</button>
                <button id="confirmDeleteBtn" class="danger">Да</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно ошибки -->
<div id="errorModal" class="modal-overlay">
    <div class="error-window modal-actions modal-window">
        <h2>Ошибка!</h2>
        <p id="errorMessage"></p>
        <button class="danger" id="closeErrorModal">Закрыть</button>
    </div>
</div>

<!-- Модальное окно успеха -->
<div id="successModal" class="modal-overlay">
    <div class="success-window modal-actions modal-window">
        <h2>Успех!</h2>
        <p id="successMessage"></p>
        <button class="danger" id="closeSuccessModal">Закрыть</button>
    </div>
</div>


</body>
</html>